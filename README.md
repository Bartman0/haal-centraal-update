# haal-centraal-update

Open source implementatie van de BRP Update API van de RvIG zoals gespecificeerd in https://github.com/BRP-API/Haal-Centraal-BRP-Update-API

## Quickstart

De eenvoudigste manier om de API te starten is door `docker compose up` uit te voeren en naar http://localhost:8083/haalcentraal/api/brpupdate/ui/ te gaan. 
Vergeet dan niet het Bearer token dat wordt getoond op de console in te voeren bij de autorisatie (het slotje aan de rechterkant). 
De database is maar minimaal gevuld, en het gegenereerde token is specifiek voor een afnemer gedefinieerd. 
Door `auth.encode_token(subject, roles=list())` aan te roepen met een ander `subject` (==afnemer_code) kan een token worden gegenereerd voor een andere afnemer. 
Het script `genereer_token.py` doet precies dat, dus op de command-line kan dat worden gebruikt (`./genereer_token.py <code voor afnemer>`).

Het is eigenlijk de bedoeling deze tokens af te laten hangen van andere IDP's zoals Entra ID.

## Configuratie

De volgende environment variabelen moeten gezet worden:

- APP_ENVIRONMENT={development|production}: een aanduiding van de te gebruiken environment context; vrije waardes die zelf gekozen kunnen worden en doorwerken in de suffix van de overige variabelen
- SQLALCHEMY_DRIVER_DEVELOPMENT="postgresql+psycopg": de te gebruiken SQLAlchemy driver; alleen "postgresql+psycopg" is getest
- POSTGRESQL_HOST_DEVELOPMENT="localhost": de database host waarop de volgindicaties worden onderhouden
- POSTGRESQL_PORT_DEVELOPMENT="5432": de port van de database host
- POSTGRESQL_DATABASE_DEVELOPMENT="brp_update": de database waarin de volgindicaties worden bijgehouden
- POSTGRESQL_USERNAME_DEVELOPMENT="richardkooijman": het user account waarmee op de volgindicaties database ingelogd moet worden
- POSTGRESQL_PASSWORD_DEVELOPMENT="**\*\*\*\***": het wachtwoord waarmee op de volgindicaties database ingelogd moet worden
- SECRET_KEY_DEVELOPMENT="secret": de sleutel waarmee tokens gegenereerd worden en mee worden gevalideerd

## Belangrijk

- dit is een PoC van de BRP Update API van de RvIG om te laten zien hoe je deze API zou kunnen implementeren
- de setup gaat uit van een volgindicaties database op PostgreSQL; wil je een ander type database gebruiken dan is de code daarop voorbereid door het gebruik van SQLAlchemy, maar er zullen nog wel wat aanpassingen nodig zijn in config.py om het helemaal database agnostisch te maken
- wijzigingen op personen worden nu gehaald uit dezelfde PostgreSQL database als de volgindicaties tabel; de wijzigingen tabel heet bsn_lijst en bestaat uit twee kolommen: burgerservicenummer en updated_at, het tijdstip waarop de laatste wijziging is uitgevoerd op de desbetreffende persoon cq het desbetreffende burgerservicenummer
- het overzetten naar een andere database is niet heel ingewikkeld: de database connectie in openapi_server/controllers/raadplegen_gewijzigde_personen_controller.py moet op een andere manier geconfigureerd worden; de gebruikte SQL kan ook nog wat aanpassingen behoeven maar is redelijk standaard ANSI-SQL
- de setup maakt voor autorisaties gebruik van zelfgegenereerde tokens (bij opstart van de service wordt een valide token gelogd); om dit over te zetten naar bijvoorbeeld Entra ID is nog wat werk nodig:
  1. tokens hoeven niet meer gegenereerd te worden, deze moeten volgen uit authenticatie tegen een application ID in Entra ID
  2. de validatie van de ontvangen tokens moet ook tegen Entra ID worden uitgevoerd; dit houdt in dat de public keys van de application bevraagd moeten worden en nadat de thumbprint is bepaald moet de validiteit op basis van de correcte sleutel worden uitgevoerd

## TODO

1. het vulscript voor de database uitbreiden met meer data
1. database voor wijzigingen op personen losmaken van de database voor volgindicaties opdat deze onafhankelijk kan worden geconfigureerd
2. testen onder belasting
3. unittests toevoegen voor het detecteren van regressieproblemen
4. uitgebreider acceptatietesten

<br/>

# OpenAPI generated server

## Overview

This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the
[OpenAPI-Spec](https://openapis.org) from a remote server, you can easily generate a server stub. This
is an example of building a OpenAPI-enabled Flask server.

This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

## Requirements

Python 3.5.2+

## Usage

To run the server, please execute the following from the root directory:

```
pip3 install -r requirements.txt
python3 -m openapi_server
```

and open your browser to here:

```
http://localhost:8083/haalcentraal/api/brpupdate/ui/
```

Your OpenAPI definition lives here:

```
http://localhost:8083/haalcentraal/api/brpupdate/openapi.json
```

To launch the integration tests, use tox:

```
sudo pip install tox
tox
```

## Running with Docker

To run the server on a Docker container, please execute the following from the root directory:

```bash
# building the image
docker build -t openapi_server .

# starting up a container
docker run -p 8083:8083 openapi_server
```
